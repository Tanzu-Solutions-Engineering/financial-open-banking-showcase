apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    run:  jdbc-cdc-rabbitmq-source
  name:  jdbc-cdc-rabbitmq-source
spec:
  replicas: 1
  selector:
    matchLabels:
      name:  jdbc-cdc-rabbitmq-source
  template:
    metadata:
      labels:
        name:  jdbc-cdc-rabbitmq-source
    spec:
      containers:
        - env:
            - name: spring.application.name
              value: "jdbc-cdc-rabbitmq-source"
            - name: spring.data.gemfire.pool.locators
              valueFrom:
                configMapKeyRef:
                  name: gemfire1-config
                  key: locators
            - name: spring.datasource.url
              value: "jdbc:postgresql://postgres/postgres"
            - name: spring.datasource.username
              value: "postgres"
            - name: spring.datasource.password
              value: "CHANGEME"
            - name: cdc.source.rabbit.streamName
              value: "Account.AccountCdc"
            - name: cdc.source.schedule.cron
              value: "*/3 * * * * *"
            - name: cdc.source.jdbc.sqlSelectWithFrom
              value: "SELECT  concat( bank_id,'|',acct_id) as key,acct_id,  acct_id id, bank_id, acct_label as label, acct_number number, acct_product_cd product_code, acct_routings, acct_views_basic views_basic, acct_balance balance, update_ts FROM bank_accounts"
            - name: cdc.source.jdbc.sqlSqlWhereClause
              value: "where ACCT_ID > ? or UPDATE_TS > ?"
            - name: rabbitmq.streaming.uris
              value: "rabbitmq-stream://cdc:cdc@rabbitmq:5552/%2f"
            - name: cdc.source.jdbc.lastRowIdWherePosition
              value: "1"
            - name: cdc.source.jdbc.lastTimestampWherePosition
              value: "2"
            - name: cdc.source.jdbc.lastRowIdSelectColumnName
              value: "ACCT_ID"
            - name: cdc.source.jdbc.cdcId
              value: "Account"
            - name: cdc.source.jdbc.lastTimestampSelectColumnName
              value: "UPDATE_TS"
            - name: spring.rabbitmq.stream.host
              value: "rabbitmq"
            - name: rabbitmq.streaming.stream.maxAgeHours
              value: "7"
            - name: rabbitmq.streaming.stream.maxLengthGb
              value: "1"
            - name: rabbitmq.streaming.stream.maxSegmentSizeMb
              value: "500"
            - name: spring.rabbitmq.host
              value: "rabbitmq"
            - name: spring_rabbitmq_username
              value: "cdc"
            - name: spring.rabbitmq.password
              value: "cdc"
          image: cloudnativedata/jdbc-cdc-rabbitmq-source:0.0.1-SNAPSHOT
          name: jdbc-cdc-rabbitmq-source
          imagePullPolicy: Always